<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Password Generator — pixelated nerd</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%230f1221'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial, Helvetica, sans-serif' font-size='34' font-weight='700' fill='%237aa2ff'%3EPN%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#0f1221; /* deep indigo */
      --panel:#161a2f;
      --muted:#8b93b3;
      --text:#eef1ff;
      --accent:#7aa2ff;
      --accent-2:#34d399;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#22c55e;
      --shadow: 0 20px 40px rgba(0,0,0,.4);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:#070a18; /* base behind animated layers */
    }

    .container{ max-width:980px; margin: clamp(20px,5vh,50px) auto; padding: 20px; position:relative; z-index:1; }
    header h1{ font-size: clamp(28px, 4vw, 42px); margin: 0 0 8px; letter-spacing: .4px; }
    header p{color:var(--muted); margin:6px 0 22px}
    header .byline{color:var(--muted); font-weight:600; letter-spacing:.3px; margin-top:2px}
    header .brand{color:var(--text); opacity:.9}

    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    @media (max-width: 900px){ .grid{grid-template-columns: 1fr} }

    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; backdrop-filter: blur(6px); }

    .output{display:block}
    .pwd{
      width:100%;
      font: 600 18px/1.3 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      padding: 10px 12px;
      color: var(--text);
      background: #0a0d1d;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      resize: none;
      overflow:hidden; /* allow JS to resize height */
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .btn{ -webkit-tap-highlight-color: transparent; cursor:pointer; border: 1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.14)); color: #eaf2ff; padding: 12px 14px; border-radius: 12px; font-weight: 600; transition: transform .05s ease, filter .2s ease, background .2s ease; }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform: translateY(1px)}
    .btn.secondary{background: linear-gradient(180deg, rgba(52,211,153,.22), rgba(52,211,153,.12));}
    .btn.ghost{background: transparent;border-color: rgba(255,255,255,.18)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .controls{display:grid; grid-template-columns: 1fr; gap: 14px}

    fieldset{border:0;margin:0;padding:0}
    .group{background: var(--panel);border:1px solid rgba(255,255,255,.06);border-radius: 14px;padding: 14px}
    .group h3{margin:0 0 10px;font-size: 15px;color:var(--muted);font-weight:700;letter-spacing:.2px}

    .row{display:flex;align-items:center;gap:10px}
    .row > label{flex: 1}

    .range-wrap{display:grid;grid-template-columns: 1fr auto;gap:10px;align-items:center}
    input[type=range]{width:100%}
    input[type=number]{width: 90px;padding:8px;border-radius: 8px;border:1px solid rgba(255,255,255,.12);background:#0a0d1d;color:var(--text)}

    .check{display:flex; align-items:center; gap:10px; padding:8px 0}
    .check input{width:20px;height:20px}
    .check label{flex:1}

    .stats{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius: 999px;background:#10142a;border:1px solid rgba(255,255,255,.08);}
    .badge strong{color:var(--text)}

    .meter{position:relative;height:12px;background:#0a0d1d;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .meter > span{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#ef4444,#f59e0b,#f59e0b,#22c55e,#22c55e);transition: width .3s ease}
    .meter-label{font-weight:700}

    .help{color:var(--muted); font-size: 14px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    /* --- Cyberpunk animated background --- */
    .cyber-bg{position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; background:#070a18}
    .cyber-bg .aurora, .cyber-bg .grid, .cyber-bg .scanlines, .cyber-bg .glow{position:absolute; inset:-10%}
    .cyber-bg .aurora{
      background:
        radial-gradient(50% 60% at 15% 10%, rgba(255,0,200,.20), transparent 60%),
        radial-gradient(60% 50% at 85% 80%, rgba(0,200,255,.18), transparent 60%),
        radial-gradient(40% 40% at 60% 30%, rgba(0,255,170,.12), transparent 60%);
      filter: blur(30px);
      animation: drift 18s ease-in-out infinite alternate;
    }
    .cyber-bg .grid{
      background-image:
        linear-gradient(rgba(122,162,255,.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(122,162,255,.08) 1px, transparent 1px);
      background-size: 80px 80px, 80px 80px;
      background-position: 0 0, 0 0;
      mask-image: radial-gradient(80% 60% at 50% 40%, #000 60%, transparent 100%);
      -webkit-mask-image: radial-gradient(80% 60% at 50% 40%, #000 60%, transparent 100%);
      animation: gridPan 30s linear infinite;
      opacity:.55;
    }
    .cyber-bg .scanlines{
      background: repeating-linear-gradient(to bottom, rgba(255,255,255,.035) 0 1px, transparent 1px 3px);
      mix-blend-mode: soft-light;
      opacity:.15;
      animation: scan 9s linear infinite;
    }
    .cyber-bg .glow{
      width:60vmax; height:60vmax; left:50%; top:50%; transform:translate(-50%,-50%);
      background: radial-gradient(circle at 50% 50%, rgba(122,162,255,.22), transparent 60%);
      filter: blur(40px);
      animation: pulse 10s ease-in-out infinite;
      opacity:.6;
    }
    @keyframes gridPan{0%{background-position:0 0,0 0}100%{background-position:0 80px,80px 0}}
    @keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}50%{transform:translate3d(2%,-1%,0) scale(1.05)}100%{transform:translate3d(0,0,0) scale(1)}}
    @keyframes scan{0%{background-position-y:0}100%{background-position-y:100px}}
    @keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);opacity:.55}50%{transform:translate(-50%,-50%) scale(1.1);opacity:.9}100%{transform:translate(-50%,-50%) scale(1);opacity:.55}}

    .btn.small{padding:6px 10px;font-size:14px}
    .history-list{margin-top:10px;max-height:280px;overflow:auto;display:grid;gap:8px}
    .history-item{display:flex;align-items:center;justify-content:space-between;background:#0a0d1d;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px}
    .history-item code{font:600 15px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;overflow-wrap:anywhere}
    .hist-left{display:flex;align-items:center;gap:8px}
    .hist-meta{color:var(--muted);font-size:12px}
    .hist-actions{display:flex;gap:6px}

    /* spacing around history card */
    #historyCard{margin-top:28px}

    /* tags and badges */
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin-left:10px}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.15);background:#0f1428;color:var(--text);opacity:.9}
    .pill.site{border-color:rgba(122,162,255,.4)}
    .pill.user{border-color:rgba(52,211,153,.4)}
  </style>
</head>
<body>
  <div class="cyber-bg">
    <div class="aurora"></div>
    <div class="grid"></div>
    <div class="scanlines"></div>
    <div class="glow"></div>
  </div>
  <div class="container">
    <header>
      <h1>Password Generator</h1>
      <div class="byline">made by <span class="brand">pixelated nerd</span></div>
      <p>Create strong passwords for your online accounts in the blink of an eye.</p>
    </header>

    <section class="grid">
      <!-- Left: Output + Strength -->
      <div class="card" aria-live="polite">
        <div class="output">
          <textarea id="password" class="pwd" rows="1" readonly aria-label="Generated password" spellcheck="false"></textarea>
        </div>
        <div class="actions" role="group" aria-label="Password actions">
          <button id="copyBtn" class="btn ghost" title="Copy to clipboard">Copy</button>
          <button id="genBtn" class="btn secondary" title="Generate a password">Generate</button>
          <button id="clearTop" class="btn ghost" title="Clear password field">Clear</button>
        </div>
        <div class="stats">
          <div class="badge" title="How unpredictable the password is (more is better)"><span class="meter-label">Entropy</span> <strong><span id="entropy">0</span> bits</strong></div>
          <div class="badge" title="Very rough guess at offline cracking time at 10B guesses/sec">Est. crack time ≈ <strong><span id="crack">—</span></strong></div>
          <div class="badge" title="Size of the allowed character pool">Pool <strong><span id="pool">0</span></strong></div>
        </div>
        <div class="meter" aria-hidden="true" style="margin-top:12px"><span id="meterFill"></span></div>
        <p class="help" style="margin-top:10px">Rule of thumb: aim for ≥ 60 bits for personal accounts, ≥ 80 for anything sensitive. Use a manager when you can.</p>
        <p id="msg" class="help" role="status" aria-live="polite"></p>
      </div>

      <!-- Right: Controls -->
      <div class="card">
        <form id="controls" class="controls" onsubmit="return false">
          <fieldset class="group">
            <h3>Length</h3>
            <div class="range-wrap">
              <input id="len" type="range" min="4" max="64" value="30" />
              <input id="lenNum" type="number" min="4" max="64" value="30" aria-label="Password length" />
            </div>
          </fieldset>

          <fieldset class="group">
            <h3>Character sets</h3>
            <div class="check"><input id="lower" type="checkbox" checked><label for="lower">Lowercase (a–z)</label></div>
            <div class="check"><input id="upper" type="checkbox" checked><label for="upper">Uppercase (A–Z)</label></div>
            <div class="check"><input id="digits" type="checkbox" checked><label for="digits">Digits (0–9)</label></div>
            <div class="check"><input id="symbols" type="checkbox"><label for="symbols">Symbols (!@#…)</label></div>
            <div class="check"><input id="excludeSim" type="checkbox"><label for="excludeSim">Avoid similar/ambiguous characters (O,0,l,1,I,|,S,5,…) </label></div>
          </fieldset>

          <fieldset class="group">
            <h3>Context (optional)</h3>
            <div class="row">
              <label for="site">Website</label>
              <input id="site" type="text" placeholder="example.com or full URL" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#0a0d1d;color:var(--text)" />
            </div>
            <div class="row" style="margin-top:8px">
              <label for="username">Username</label>
              <input id="username" type="text" placeholder="optional" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#0a0d1d;color:var(--text)" />
            </div>
          </fieldset>
        </form>
      </div>
    </section>

    <section class="card" id="historyCard" aria-labelledby="historyTitle">
      <div class="row" style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 id="historyTitle" style="margin:0">History (this device)</h3>
        <div class="row" style="gap:8px;align-items:center;flex:1;justify-content:flex-end">
          <input id="histFilter" type="text" placeholder="Search… (site, user, password)" style="max-width:320px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0a0d1d;color:var(--text)" />
          <button id="exportHist" class="btn ghost small" type="button" title="Download a .txt backup">Export .txt</button>
          <button id="clearHist" class="btn ghost small" type="button" title="Remove all saved passwords">Clear history</button>
        </div>
      </div>
      <div id="historyList" class="history-list" role="list"></div>
      <p class="help" style="margin-top:8px">Saved locally using your browser storage. Nothing is uploaded. Works across tabs and windows on this device.</p>
    </section>

    <footer class="help" style="margin-top:16px; text-align:center">
      <p style="margin:0">This generator uses the browser's cryptographic RNG (window.crypto) and shuffles characters to remove patterns. No data leaves your device.</p>
      <p style="margin:.35rem 0 0;opacity:.9">© 2025 <strong>pixelated nerd</strong></p>
    </footer>
  </div>

  <script>
  // ===== Utilities =====
  const $ = sel => document.querySelector(sel);
  const msg = (text, kind = 'info') => {
    const m = $('#msg');
    m.textContent = text || '';
    m.style.color = kind === 'error' ? 'var(--danger)' : (kind === 'warn' ? 'var(--warn)' : 'var(--muted)');
  };

  // Run self-tests only if URL contains ?selftest
  const SELF_TEST = new URLSearchParams(location.search).has('selftest');

  function secureRandomInt(maxExclusive){
    if (maxExclusive <= 0) return 0;
    const range = 0x100000000; // 2^32
    const maxUnbiased = range - (range % maxExclusive);
    const buf = new Uint32Array(1);
    let x;
    do { crypto.getRandomValues(buf); x = buf[0]; } while (x >= maxUnbiased);
    return x % maxExclusive;
  }

  function shuffleSecure(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = secureRandomInt(i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function removeChars(base, blacklist){
    const set = new Set(blacklist.split(''));
    return [...base].filter(c => !set.has(c)).join('');
  }

  function escapeHtml(s){
    if (s == null) return '';
    return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }
  function normalizeSite(s){
    if (!s) return '';
    s = String(s).trim();
    try {
      const u = new URL(s.includes('://') ? s : 'https://' + s);
      return u.hostname.replace(/^www\./,'');
    } catch(e){
      return s.replace(/^https?:\/\//,'').replace(/^www\./,'');
    }
  }

  function copyText(str){
    if (!str) { msg('Nothing to copy yet. Hit Generate first.', 'warn'); return Promise.resolve(false); }
    if (navigator.clipboard && window.isSecureContext){
      return navigator.clipboard.writeText(str)
        .then(()=>{ msg('Copied to clipboard.'); return true; })
        .catch(()=> fallback());
    }
    return fallback();
    function fallback(){
      try{
        const ta = document.createElement('textarea');
        ta.value = str; ta.setAttribute('readonly','');
        ta.style.position = 'fixed'; ta.style.left = '-9999px'; ta.style.top = '0';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        if (ok) { msg('Copied to clipboard.'); return true; }
      }catch(e){ /* noop */ }
      msg('Copy failed. Select and press Ctrl/Cmd+C.', 'warn');
      return false;
    }
  }

  function closestButton(target){
    let el = target;
    while (el && el !== document){
      if (el.matches && el.matches('button[data-act]')) return el;
      el = el.parentNode;
    }
    return null;
  }
  function closestHistoryItem(el){
    let n = el;
    while (n && n !== document){
      if (n.classList && n.classList.contains('history-item')) return n;
      n = n.parentNode;
    }
    return null;
  }
  function confirmDelete(){
    return window.confirm('Delete this password permanently from this device? This cannot be undone.');
  }
  function handleHistoryAction(act, id){
    const arr = getHistory();
    const row = arr.find(x=>x.id===id);
    if (!row) return false;
    if (act==='copy'){
      copyText(row.pwd);
      return true;
    }
    if (act==='use'){
      $('#password').value = row.pwd; $('#password').title = row.pwd; autoSizePwd(); msg('Restored from history.');
      return true;
    }
    if (act==='edit'){
      const newSite = prompt('Website (domain or URL):', row.site || '');
      if (newSite === null) return false;
      const newUser = prompt('Username (optional):', row.user || '');
      if (newUser === null) return false;
      row.site = normalizeSite(newSite);
      row.user = (newUser||'').trim();
      setHistory(arr);
      renderHistory();
      return true;
    }
    if (act==='del'){
      if (!confirmDelete()) return false;
      deleteHistory(id);
      msg('Deleted permanently.');
      return true;
    }
    return false;
  }

  function calcEntropyBits(length, poolSize){
    if (poolSize <= 1 || length <= 0) return 0;
    return +(length * (Math.log(poolSize) / Math.LN2)).toFixed(2);
  }

  function formatCrackTime(bits){
    const rate = 1e10; // guesses/sec
    const seconds = Math.pow(2, Math.min(bits, 1024)) / rate;
    if (!isFinite(seconds) || seconds > 1e20) return 'cosmic time';
    if (seconds < 1) return '< 1 sec';
    const units = [ ['sec', 60], ['min', 60], ['hr', 24], ['day', 365.25], ['yr', 100], ['centuries', 10] ];
    let value = seconds; let label = 'sec';
    for (let i=0;i<units.length;i++){
      const [name, step] = units[i];
      if (value < step) { label = name; break; }
      value /= step; label = name;
    }
    if (label === 'centuries') return `~ ${value.toFixed(2)} centuries`;
    return `~ ${value.toFixed(2)} ${label}`;
  }

  function strengthFill(bits){
    const fill = $('#meterFill');
    const pct = Math.max(0, Math.min(100, (bits / 120) * 100));
    fill.style.width = pct + '%';
  }

  // ===== History (persistent, cross-tab) =====
  const HIST_KEY = 'pwdHistory_v1';
  const HIST_MAX = 500;
  const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('pwdGenHistory') : null;

  function getHistory(){
    try { return JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); } catch { return []; }
  }
  function setHistory(list){
    let arr = Array.isArray(list) ? list : [];
    if (arr.length > HIST_MAX) arr = arr.slice(0, HIST_MAX);
    try {
      localStorage.setItem(HIST_KEY, JSON.stringify(arr));
    } catch (e) {
      // Trim until we fit
      while (arr.length > 0){
        arr.pop();
        try { localStorage.setItem(HIST_KEY, JSON.stringify(arr)); break; } catch {}
      }
    }
    if (bc) bc.postMessage({type:'history-update'});
  }
  function addHistory(pwd, meta={}){
    const entry = {
      id: (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+Math.random().toString(16).slice(2))),
      pwd,
      createdAt: Date.now(),
      len: meta.len ?? null,
      include: meta.include ?? [],
      bits: meta.bits ?? null,
      site: meta.site ?? '',
      user: meta.user ?? ''
    };
    const arr = getHistory();
    arr.unshift(entry);
    setHistory(arr);
    renderHistory();
  }
  function deleteHistory(id){ setHistory(getHistory().filter(x=>x.id!==id)); renderHistory(); }
  function clearHistory(){ setHistory([]); renderHistory(); }
  function exportHistory(){
    const arr = getHistory();
    const NL = '\n';
    const txt = arr.map(e=>{
      const iso = new Date(e.createdAt).toISOString();
      const cols = [iso, e.pwd, e.site||'', e.user||''];
      return cols.join('\t');
    }).join(NL);
    const blob = new Blob([txt + NL], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='password_history.txt';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function renderHistory(){
    const wrap = document.getElementById('historyList');
    if (!wrap) return;
    const filter = (document.getElementById('histFilter')?.value || '').toLowerCase().trim();
    let arr = getHistory();
    if (filter){
      arr = arr.filter(e => (e.pwd||'').toLowerCase().includes(filter)
        || (e.site||'').toLowerCase().includes(filter)
        || (e.user||'').toLowerCase().includes(filter));
    }
    if (!arr.length){ wrap.innerHTML = '<div class="help">No passwords saved yet. Generate to add them here.</div>'; return; }
    wrap.innerHTML = arr.slice(0,200).map(e=>{
      const ts = new Date(e.createdAt).toLocaleString();
      const meta = e.bits ? ` • ${e.bits} bits` : '';
      const siteTag = e.site ? `<span class="pill site">${escapeHtml(e.site)}</span>` : '';
      const userTag = e.user ? `<span class="pill user">@${escapeHtml(e.user)}</span>` : '';
      return (
        `<div class="history-item" role="listitem" data-id="${e.id}">`
        + `<div class="hist-left">`
        + `<code>${escapeHtml(e.pwd)}</code>`
        + `<span class="hist-meta">${ts}${meta}</span>`
        + `<span class="tags">${siteTag}${userTag}</span>`
        + `</div>`
        + `<div class="hist-actions">`
        + `<button type="button" class="btn ghost small" data-id="${e.id}" data-act="use">Use</button>`
        + `<button type="button" class="btn ghost small" data-id="${e.id}" data-act="copy">Copy</button>`
        + `<button type="button" class="btn ghost small" data-id="${e.id}" data-act="edit">Edit</button>`
        + `<button type="button" class="btn ghost small" data-id="${e.id}" data-act="del" title="Delete permanently">Delete</button>`
        + `</div>`
        + `</div>`
      );
    }).join('');
    bindHistoryRowEvents();
  }

  function bindHistoryRowEvents(){
    const wrap = document.getElementById('historyList');
    if (!wrap) return;
    wrap.querySelectorAll('button[data-act]').forEach(btn => {
      if (btn.dataset.bound) return; // avoid duplicate bindings after rerender
      btn.dataset.bound = '1';
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const id = btn.getAttribute('data-id') || btn.closest('.history-item')?.dataset?.id;
        const act = btn.getAttribute('data-act');
        if (!id || !act) return;
        handleHistoryAction(act, id);
      });
    });
  }
  // Cross-tab sync
  window.addEventListener('storage', (e)=>{ if (e.key === HIST_KEY) renderHistory(); });
  if (bc) bc.onmessage = (ev)=>{ if (ev?.data?.type === 'history-update') renderHistory(); }

  // ===== Character Sets =====
  const SETS = {
    lower: 'abcdefghijklmnopqrstuvwxyz',
    upper: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
    digits: '0123456789',
    symbols: "!@#$%^&*()_+-={}[]|:;\\\"'<>.,?/\\~`",
    space: ' '
  };
  const SIMILAR = 'O0oIl1|S5B8Z2Q9G6';

  function getSelectedPool(){
    const include = [];
    if ($('#lower').checked) include.push('lower');
    if ($('#upper').checked) include.push('upper');
    if ($('#digits').checked) include.push('digits');
    if ($('#symbols').checked) include.push('symbols');
    if (document.getElementById('allowSpace')?.checked) include.push('space');

    let pools = include.map(key => SETS[key]);
    if ($('#excludeSim').checked){ pools = pools.map(s => removeChars(s, SIMILAR)); }
    const poolJoined = pools.join('');
    return { include, pools, poolJoined };
  }

  function updateStats(){
    const len = +$('#len').value;
    const { pools, poolJoined } = getSelectedPool();
    const poolSize = [...new Set(poolJoined.split(''))].length;
    const bits = calcEntropyBits(len, poolSize);
    $('#entropy').textContent = bits;
    $('#crack').textContent = formatCrackTime(bits);
    $('#pool').textContent = poolSize;
    strengthFill(bits);

    const types = pools.filter(s => s.length>0).length;
    const forceEach = document.getElementById('forceEach') ? document.getElementById('forceEach').checked : true;
    const gen = $('#genBtn');
    const regen = document.getElementById('regen');
    const disableAll = () => { if(gen) gen.disabled = true; if(regen) gen.disabled = true; };
    const enableAll  = () => { if(gen) gen.disabled = false; if(regen) gen.disabled = false; };

    if (poolSize === 0){ msg('Pick at least one character set.', 'warn'); disableAll(); return; }
    if (forceEach && len < types){ msg(`Increase length to at least ${types} to include all chosen sets.`, 'warn'); disableAll(); return; }
    msg(''); enableAll();
  }

  function makePassword(len, pools, poolArr, forceEach){
    const out = [];
    if (forceEach){ pools.forEach(set => { if (set.length){ out.push(set[secureRandomInt(set.length)]); } }); }
    while (out.length < len){ out.push(poolArr[secureRandomInt(poolArr.length)]); }
    shuffleSecure(out);
    return out.slice(0, len).join('');
  }

  function autoSizePwd(){
    const el = $('#password');
    if (!el) return;
    el.style.height = '0px';
    el.style.height = el.scrollHeight + 'px';
  }

  function generate(save = true){
    const len = +$('#len').value;
    const { include, pools, poolJoined } = getSelectedPool();
    const poolArr = [...new Set(poolJoined.split(''))];
    if (poolArr.length === 0) return '';

    const forceEach = document.getElementById('forceEach') ? document.getElementById('forceEach').checked : true;
    const pwd = makePassword(len, pools, poolArr, forceEach);
    const field = $('#password');
    field.value = pwd; field.title = pwd; autoSizePwd(); updateStats();

    // Gather context
    const siteRaw = document.getElementById('site')?.value.trim() || '';
    const user = document.getElementById('username')?.value.trim() || '';
    const site = normalizeSite(siteRaw);

    // Save to history with metadata
    const bits = calcEntropyBits(len, poolArr.length);
    if (save) addHistory(pwd, { len, include, bits, site, user });
    return pwd;
  }

  function copyPwd(){
    const val = $('#password').value;
    copyText(val);
  }

  function syncLenInputs(e){
    const range = $('#len');
    const num = $('#lenNum');
    if (e && e.target === range) num.value = range.value;
    if (e && e.target === num) { const v = Math.max(+num.min, Math.min(+num.max, +num.value||16)); num.value = v; range.value = v; }
    updateStats();
  }

  // ===== Event Wiring =====
  function setFavicon(){
    try{
      const size = 64;
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,size,size);

      // helper: rounded rect
      function rrect(x,y,w,h,r){
        ctx.beginPath();
        ctx.moveTo(x+r,y);
        ctx.arcTo(x+w,y,x+w,y+h,r);
        ctx.arcTo(x+w,y+h,x,y+h,r);
        ctx.arcTo(x,y+h,x,y,r);
        ctx.arcTo(x,y,x+w,y,r);
        ctx.closePath();
      }

      // background rounded square (subtle vertical gradient)
      const bg = ctx.createLinearGradient(0,0,0,size);
      bg.addColorStop(0,'#12162b');
      bg.addColorStop(1,'#0b0e1d');
      ctx.fillStyle = bg;
      rrect(4,4,size-8,size-8,14);
      ctx.fill();

      // subtle inner stroke for definition
      ctx.strokeStyle = 'rgba(255,255,255,.12)';
      ctx.lineWidth = 1;
      rrect(4.5,4.5,size-9,size-9,14);
      ctx.stroke();

      // PN letters (soft cyan gradient)
      const tg = ctx.createLinearGradient(0,0,0,size);
      tg.addColorStop(0,'#9bb5ff');
      tg.addColorStop(1,'#7aa2ff');
      ctx.fillStyle = tg;
      ctx.font = 'bold 34px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('PN', size/2, size/2+1);

      const url = canvas.toDataURL('image/png');
      let link = document.querySelector('link[rel="icon"]');
      if (!link){ link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
      link.href = url;
    }catch(e){ /* ignore */ }
  }

  window.addEventListener('DOMContentLoaded', () => {
    // Buttons
    $('#genBtn').addEventListener('click', () => generate(true));
    const regen = document.getElementById('regen'); if (regen) regen.addEventListener('click', () => generate(true));
    $('#copyBtn').addEventListener('click', copyPwd);
    const clearTop = document.getElementById('clearTop'); if (clearTop) clearTop.addEventListener('click', () => { $('#password').value=''; autoSizePwd(); msg('Cleared.'); });

    // Controls (guard missing ones)
    ['lower','upper','digits','symbols','excludeSim','forceEach','allowSpace']
      .forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('change', () => { updateStats(); generate(false); }); });

    $('#len').addEventListener('input', (e)=>{ syncLenInputs(e); generate(false); });
    $('#lenNum').addEventListener('input', (e)=>{ syncLenInputs(e); generate(false); });

    window.addEventListener('resize', autoSizePwd);

    // Init
    setFavicon();
    updateStats();
    generate(false);
  });

  // History listeners (container-level delegation for reliability)
  window.addEventListener('DOMContentLoaded', () => {
    renderHistory();
    const list = document.getElementById('historyList');
    if (list){
      list.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const item = btn.closest('.history-item');
        const id = btn.getAttribute('data-id') || item?.dataset?.id;
        const act = btn.getAttribute('data-act');
        if (!act || !id) return;
        handleHistoryAction(act, id);
      });
    }
    document.getElementById('clearHist')?.addEventListener('click', clearHistory);
    document.getElementById('exportHist')?.addEventListener('click', exportHistory);
    document.getElementById('histFilter')?.addEventListener('input', renderHistory);
  });

  // ===== Dev/self-tests (console only) =====
  function runTests(){
    let failures = 0; const logFail = (m) => { console.error(m); failures++; };

    // Save current state
    const state = {
      len: $('#len').value,
      lower: $('#lower').checked,
      upper: $('#upper').checked,
      digits: $('#digits').checked,
      symbols: $('#symbols').checked,
      excludeSim: $('#excludeSim').checked,
      site: document.getElementById('site')?.value || '',
      username: document.getElementById('username')?.value || ''
    };

    const restore = () => {
      $('#len').value = state.len; $('#lenNum').value = state.len;
      $('#lower').checked = state.lower; $('#upper').checked = state.upper;
      $('#digits').checked = state.digits; $('#symbols').checked = state.symbols;
      $('#excludeSim').checked = state.excludeSim;
      const siteEl = document.getElementById('site'); if (siteEl) siteEl.value = state.site;
      const userEl = document.getElementById('username'); if (userEl) userEl.value = state.username;
      updateStats();
    };

    try {
      // Test 1: length 30 and includes required types
      $('#len').value = 30; $('#lenNum').value = 30;
      $('#lower').checked = true; $('#upper').checked = true; $('#digits').checked = true; $('#symbols').checked = false; updateStats();
      const p1 = generate();
      console.assert(p1.length === 30, 'Password length should be 30');
      const hasLower = /[a-z]/.test(p1), hasUpper = /[A-Z]/.test(p1), hasDigit = /[0-9]/.test(p1);
      if (!(hasLower && hasUpper && hasDigit)) logFail('Should include at least one of each selected type');

      // Test 2: digits only
      $('#lower').checked = false; $('#upper').checked = false; $('#digits').checked = true; $('#symbols').checked = false; updateStats();
      $('#len').value = 10; $('#lenNum').value = 10; updateStats();
      const p2 = generate();
      if (!/^[0-9]{10}$/.test(p2)) logFail('Digits-only generation failed');

      // Test 3: exclude similar characters
      $('#upper').checked = true; $('#digits').checked = true; $('#excludeSim').checked = true; updateStats();
      const p3 = generate();
      if (/[O0oIl1|S5B8Z2Q9G6]/.test(p3)) logFail('Similar characters should be excluded');

      // Test 4: secureRandomInt range
      for (let i=0;i<100;i++){
        const n = secureRandomInt(17);
        if (!(Number.isInteger(n) && n >= 0 && n < 17)) logFail('secureRandomInt out of range');
      }

      // Test 5: lowercase-only should only contain a–z
      $('#lower').checked = true; $('#upper').checked = false; $('#digits').checked = false; $('#symbols').checked = false; updateStats();
      $('#len').value = 16; $('#lenNum').value = 16; updateStats();
      const p4 = generate();
      if (!/^[a-z]{16}$/.test(p4)) logFail('Lowercase-only generation failed');

      // Test 6: history appends on generation
      const before = getHistory().length;
      $('#len').value = 12; $('#lenNum').value = 12; $('#lower').checked = true; $('#upper').checked = false; $('#digits').checked = true; $('#symbols').checked = false; updateStats();
      const p5 = generate();
      const after = getHistory().length;
      if (!(after === before + 1)) logFail('History should append a new entry on generate');
      const latest = getHistory()[0]?.pwd;
      if (latest !== p5) logFail('Latest history entry should match most recent password');

      // Test 7: context saved (site normalization)
      document.getElementById('site').value = 'https://www.Example.com/login';
      document.getElementById('username').value = 'alice';
      const p6 = generate();
      const rec = getHistory()[0];
      if (rec.pwd !== p6 || rec.site !== 'example.com' || rec.user !== 'alice') logFail('Context (site/user) not saved/normalized');

      // Test 8: delete removes entry
      const delBefore = getHistory().length;
      const delId = getHistory()[0]?.id;
      if (delId){ deleteHistory(delId); const delAfter = getHistory().length; if (delAfter !== delBefore - 1) logFail('Delete should remove one entry'); }

      // Test 9: 'use' action applies password
      const idToUse = getHistory()[0]?.id;
      if (idToUse){
        const expected = getHistory().find(x=>x.id===idToUse)?.pwd;
        $('#password').value = '';
        handleHistoryAction('use', idToUse);
        const usedVal = $('#password').value;
        if (usedVal !== expected) logFail('Use action should place password into field');
      }

      // Test 10: 'del' action via handler respects confirm and removes
      const idToDel = getHistory()[0]?.id;
      if (idToDel){
        const beforeDel = getHistory().length;
        const prevConfirm = confirmDelete;
        confirmDelete = () => true; // auto-confirm for test
        handleHistoryAction('del', idToDel);
        confirmDelete = prevConfirm;
        const afterDel = getHistory().length;
        if (afterDel !== beforeDel - 1) logFail('Delete action via handler should remove one entry');
      }

      if (failures === 0) console.log('✅ Self-tests passed');
      else console.warn(`❌ Self-tests failed: ${failures}`);
    } catch (e){
      console.error('❌ Self-tests crashed:', e);
    } finally {
      restore();
      generate(false);
    }
  }
  window.addEventListener('DOMContentLoaded', () => { if (SELF_TEST) runTests(); });

  // Global shortcuts: g = generate, c = copy, x = clear (ignored while typing)
  window.addEventListener('keydown', (e)=>{
    const tag = (document.activeElement && document.activeElement.tagName) || '';
    if (tag === 'INPUT' || tag === 'TEXTAREA') return; // don't hijack typing
    const k = e.key.toLowerCase();
    if (k === 'g'){ e.preventDefault(); generate(); }
    if (k === 'c'){ e.preventDefault(); copyPwd(); }
    if (k === 'x'){ e.preventDefault(); $('#password').value=''; autoSizePwd(); msg('Cleared.'); }
  });
  </script>

</body>
</html>
